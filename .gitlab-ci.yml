image: node:18 # 使用 Node.js 18 版本，可根据需要修改

stages:
  - sync
  - build

variables:
  BUILD_DIR: ".vitepress/dist"
  MIRROR_REPO: "https://gitee.com/Sugarscat/note.git"


sync_repo:
  stage: sync
  script:
    - git config --global user.name "GitLab CI"
    - git config --global user.email "ci@sugarscat.com"
    # 确保远程仓库 mirror 存在，如果已存在则不重复添加
    - git remote | grep -q mirror || git remote add mirror $MIRROR_REPO
    # 获取远程最新的 main 分支
    - git fetch mirror main
    # 判断是否有更新
    - |
      if [ "$(git rev-parse HEAD)" != "$(git rev-parse mirror/main)" ]; then
        echo "Changes detected, syncing..."
        git pull mirror main
        git push origin main
      else
        echo "No changes detected."
      fi
  only:
    - schedules

build:
  stage: build
  script:
    - npm config set registry https://registry.npmmirror.com # 设置淘宝镜像
    - npm install
    - npm run docs:build
  artifacts:
    paths:
      - $BUILD_DIR
  only:
    - main # 只在 main 分支执行
  rules:
    - if: '$CI_PIPELINE_SOURCE != "schedule"'  # 不在 schedule 触发
