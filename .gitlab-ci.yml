stages:
  - mirror-sync
  - build

variables:
  BUILD_DIR: ".vitepress/dist"
  TARGET_BRANCH: "main" # éœ€è¦åŒæ­¥çš„ç›®æ ‡åˆ†æ”¯

mirror-sync:
  stage: mirror-sync
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"  # é€šè¿‡å®šæ—¶ä»»åŠ¡è§¦å‘
  before_script:
    # ä½¿ç”¨å›½å†…é•œåƒæºåŠ é€Ÿå®‰è£…
    - echo "https://mirrors.aliyun.com/alpine/v3.18/main" > /etc/apk/repositories
    - apk add --no-cache git openssh-client
  script: |
    echo "ğŸ› ï¸ é…ç½®Gitèº«ä»½"
    git config --global user.name "CI/CD"
    git config --global user.email "cicd@sugarscat.cn"
    
    echo "ğŸ”‘ é…ç½®Gitè®¤è¯"
    git remote remove origin || true
    git remote add origin "https://oauth2:${REPO_TOKEN}@${THE_REPO}"
    git fetch origin
    
    echo "ğŸ“¦ æ·»åŠ é•œåƒä»“åº“"
    git remote remove mirror || true
    git remote add mirror $MIRROR_REPO
    git fetch mirror

    echo "ğŸ’¾ åˆå¹¶é•œåƒä»“åº“ä»£ç ï¼ˆå¼ºåˆ¶åˆå¹¶ç­–ç•¥ï¼‰"
    git checkout -B main
    git merge -Xours mirror/$TARGET_BRANCH
    
    echo "ğŸš€ å¼ºåˆ¶æ¨é€å›æºä»“åº“"
    git push --force origin main

build:
  stage: build
  image: node:22.14.0
  before_script:
    - npm config set registry https://registry.npmmirror.com # è®¾ç½®æ·˜å®é•œåƒ
  script:
    - npm install
    - echo "ğŸ“¦ å¼€å§‹æ„å»º Â·Â·Â·"
    - npm run docs:build
  artifacts:
    paths:
      - $BUILD_DIR
  rules:
    # å½“é å®šæ—¶è§¦å‘ ä¸”ä½äº main åˆ†æ”¯æ—¶æ‰§è¡Œã€‚
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "schedule"'
