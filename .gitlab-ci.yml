stages:
  - mirror-sync
  - build

variables:
  BUILD_DIR: ".vitepress/dist"
  MIRROR_REPO: "https://gitee.com/Sugarscat/note.git"
  TARGET_BRANCH: "main" # éœ€è¦åŒæ­¥çš„ç›®æ ‡åˆ†æ”¯

mirror-sync:
  stage: mirror-sync
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"  # é€šè¿‡å®šæ—¶ä»»åŠ¡è§¦å‘
  before_script:
    # ä½¿ç”¨å›½å†…é•œåƒæºåŠ é€Ÿå®‰è£…
    - echo "https://mirrors.aliyun.com/alpine/v3.18/main" > /etc/apk/repositories
    - apk add --no-cache git openssh-client
  script: |
    echo "ğŸ› ï¸ é…ç½®Gitèº«ä»½"
    git config --global user.name "GitLab CI"
    git config --global user.email "ci@sugarscat.com"

    echo "ğŸ“¦ æ·»åŠ é•œåƒä»“åº“"
    git remote remove mirror || true
    git remote add mirror $MIRROR_REPO
    git fetch mirror

    echo "ğŸ’¾ åˆå¹¶é•œåƒä»“åº“ä»£ç ï¼ˆå¼ºåˆ¶åˆå¹¶ç­–ç•¥ï¼‰"
    git checkout -B main
    # åˆå¹¶ mirror ä»“åº“çš„ç›®æ ‡åˆ†æ”¯ï¼ˆä½¿ç”¨ ours ç­–ç•¥å¿½ç•¥å†²çªï¼‰ï¼Œå…è®¸ä¸åŒå†å²åˆå¹¶
    git merge --allow-unrelated-histories --strategy=ours "mirror/${TARGET_BRANCH}" -m "Force merge mirror branch ${TARGET_BRANCH}"
    
    echo "ğŸš€ å¼ºåˆ¶æ¨é€å›æºä»“åº“"
    git push --force origin main

build:
  stage: build
  image: node:18 # ä½¿ç”¨ Node.js 18 ç‰ˆæœ¬
  before_script:
    - npm config set registry https://registry.npmmirror.com # è®¾ç½®æ·˜å®é•œåƒ
  script:
    - npm install
    - echo "ğŸ“¦ å¼€å§‹æ„å»º Â·Â·Â·"
    - npm run docs:build
  artifacts:
    paths:
      - $BUILD_DIR
  rules:
    # å½“é å®šæ—¶è§¦å‘ ä¸”ä½äº main åˆ†æ”¯æ—¶æ‰§è¡Œã€‚
    - if: '$CI_COMMIT_BRANCH == "deve" && $CI_PIPELINE_SOURCE != "schedule"'
