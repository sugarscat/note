stages:
  - mirror-sync
  - build

variables:
  BUILD_DIR: ".vitepress/dist"
  MIRROR_REPO: "https://gitee.com/Sugarscat/note.git"
  TARGET_BRANCH: "main" # 需要同步的目标分支

mirror-sync:
  stage: mirror-sync
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"  # 通过定时任务触发
    - if: $CI_MERGE_REQUEST_ID  # 允许手动触发
      when: manual
  before_script:
    - apk add --no-cache git openssh-client
  script: |
    # 配置Git身份
    git config --global user.name "GitLab CI"
    git config --global user.email "ci@sugarscat.com"
    # 添加镜像仓库
    git remote add mirror $MIRROR_REPO
    git fetch mirror
    # 合并镜像仓库代码（强制合并策略）
    git checkout $CI_COMMIT_BRANCH
    # 合并 mirror 仓库的目标分支（使用 ours 策略忽略冲突），允许不同历史合并
    git merge --allow-unrelated-histories --strategy=ours "mirror/${TARGET_BRANCH}" -m "Force merge mirror branch ${TARGET_BRANCH}"
    # 强制推送回源仓库
    git push --force origin $CI_COMMIT_BRANCH

build:
  stage: build
  image: node:18 # 使用 Node.js 18 版本
  before_script:
    - npm config set registry https://registry.npmmirror.com # 设置淘宝镜像
  script:
    - npm install
    - npm run docs:build
  artifacts:
    paths:
      - $BUILD_DIR
  rules:
    # 当非 定时触发 且位于 main 分支时执行。
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "schedule"'
