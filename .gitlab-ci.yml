stages:
  - sync
  - build

variables:
  BUILD_DIR: ".vitepress/dist"
  MIRROR_REPO: "https://gitee.com/Sugarscat/note.git"

sync_repo:
  stage: sync
  image: alpine:latest # 轻量级Linux镜像
  script:
    - git config --global user.email "ci@sugarscat.cn"
    - git config --global user.name "GitLab CI"
    - git remote | grep -q mirror || git remote add mirror $MIRROR_REPO
    # 强制同步分支
    - git fetch mirror main
    - git checkout -B main --track mirror/main || (git checkout --orphan tmp && git branch -D main && git checkout -B main mirror/main)
    # 合并并处理可能的冲突（此处选择强制覆盖）
    - git reset --hard mirror/main
    # 推送到目标仓库
    - git push --force origin main:main
  only:
    - schedules

build:
  stage: build
  image: node:18 # 使用 Node.js 18 版本
  script:
    - npm config set registry https://registry.npmmirror.com # 设置淘宝镜像
    - npm install
    - npm run docs:build
  artifacts:
    paths:
      - $BUILD_DIR
  rules:
    # 当非 定时触发 且位于 main 分支时执行。
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "schedule"'
